<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Coralería • Catálogo</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#1A336A;           /* navy */
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.14);
      --text:#ffffff;
      --muted: rgba(255,255,255,.78);
      --muted2: rgba(255,255,255,.62);
      --violet:#7053B8;
      --violet2:#682E8F;
      --accent:#F79320;
      --shadow: 0 14px 50px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% -10%, rgba(112,83,184,.55), transparent 55%),
                  radial-gradient(1000px 600px at 95% 5%, rgba(247,147,32,.30), transparent 55%),
                  linear-gradient(180deg, #0f214a 0%, var(--bg) 65%, #0b1633 120%);
      color: var(--text);
      min-height:100vh;
    }

    a{ color: inherit; }

    .wrap{ max-width:1200px; margin:0 auto; padding: 0 16px; }

    header{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      background: rgba(15,33,74,.72);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 14px 0;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 240px;
    }

    .logo{
      width:44px;
      height:44px;
      border-radius: 14px;
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.12);
      flex: 0 0 auto;
      background: rgba(255,255,255,.06);
    }

    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }

    .brand h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .brand .sub{ margin:0; font-size:12px; color: var(--muted2); }

    .controls{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      flex: 1 1 auto;
      flex-wrap: wrap;
    }

    .chipbar{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      padding: 0 0 14px;
    }

    .chip{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
      transition: .15s ease;
      user-select:none;
    }

    .chip:hover{ background: rgba(255,255,255,.10); }

    .chip.active{
      border-color: rgba(247,147,32,.95);
      background: rgba(247,147,32,.14);
      box-shadow: 0 0 0 2px rgba(247,147,32,.12);
    }

    .input{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      outline: none;
      min-width: 240px;
    }

    .select{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      outline: none;
    }

    .meta{
      color: var(--muted2);
      font-size: 12px;
      text-align:right;
      min-width: 160px;
    }

    main{ padding: 18px 0 120px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 14px;
    }

    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 10px 28px rgba(0,0,0,.18);
      transition: transform .12s ease, border-color .12s ease;
    }

    .card:hover{ transform: translateY(-2px); border-color: rgba(255,255,255,.18); }

    .thumb{
      position: relative;
      aspect-ratio: 1 / 1;
      background: rgba(0,0,0,.18);
      cursor: zoom-in;
    }

    .thumb img{ width:100%; height:100%; object-fit: cover; display:block; }

    .badge{
      position:absolute;
      top:10px;
      left:10px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      background: rgba(16,52,111,.72);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(8px);
    }

    .content{ padding: 12px 12px 14px; }

    .title{
      font-weight: 850;
      letter-spacing: .1px;
      line-height: 1.2;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }

    .price{
      font-weight: 900;
      color: #ffffff;
    }

    .muted{ color: var(--muted); font-size: 12px; }

    .btn{
      border: 0;
      background: var(--accent);
      color: #1b1b1b;
      font-weight: 900;
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: filter .12s ease;
      white-space: nowrap;
    }

    .btn:hover{ filter: brightness(1.05); }

    .btn.secondary{
      background: rgba(255,255,255,.10);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.14);
      font-weight: 800;
    }

    .empty{
      margin: 24px 0;
      padding: 18px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.06);
      border: 1px dashed rgba(255,255,255,.18);
      color: var(--muted);
      text-align:center;
    }

    /* Cart button */
    .fab{
      position: fixed;
      right: 16px;
      bottom: 16px;
      border-radius: 999px;
      padding: 12px 14px;
      background: rgba(112,83,184,.25);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex;
      gap: 10px;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }

    .fab strong{ font-size: 13px; }

    .count{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: var(--accent);
      color: #1b1b1b;
      font-weight: 900;
      font-size: 13px;
    }

    /* Drawer */
    .drawerOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity .14s ease;
      z-index: 80;
    }

    .drawerOverlay.open{ opacity: 1; pointer-events: auto; }

    .drawer{
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: min(420px, 92vw);
      background: rgba(15,33,74,.92);
      border-left: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      transform: translateX(102%);
      transition: transform .18s ease;
      z-index: 90;
      display:flex;
      flex-direction: column;
    }

    .drawer.open{ transform: translateX(0); }

    .drawerHeader{
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .drawerHeader h2{ margin:0; font-size: 15px; }

    .drawerBody{ padding: 12px 16px; overflow:auto; flex: 1 1 auto; }

    .line{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .line:last-child{ border-bottom:0; }

    .qty{
      display:flex;
      align-items:center;
      gap: 8px;
      color: var(--muted);
      font-size: 12px;
    }

    .qty button{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 10px;
      width: 30px;
      height: 30px;
      cursor:pointer;
      font-weight: 900;
    }

    .drawerFooter{
      padding: 12px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(15,33,74,.92);
    }

    .drawerFooter .tot{ display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px; }

    .small{ font-size: 12px; color: var(--muted2); }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 95;
      display:none;
      place-items:center;
      padding: 16px;
      background: rgba(0,0,0,.55);
    }

    .modal.open{ display:grid; }

    .modalBox{
      width: min(1000px, 96vw);
      background: rgba(15,33,74,.94);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .modalTop strong{ font-size: 13px; }

    .modalImg{ width:100%; max-height: 78vh; object-fit: contain; display:block; background: rgba(0,0,0,.22); }

    @media (max-width: 700px){
      .meta{ display:none; }
      .input{ min-width: 180px; flex: 1 1 auto; }
      .select{ flex: 1 1 auto; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><img src="assets/logo.png" alt="La Coralería" /></div>
        <div>
          <h1>La Coralería • Catálogo</h1>
          <p class="sub">Filtra, agrega al carrito y pide por WhatsApp 💬</p>
        </div>
      </div>

      <div class="controls">
        <input id="q" class="input" placeholder="Buscar especie..." autocomplete="off" />
        <select id="sort" class="select">
          <option value="recent">Recientes</option>
          <option value="az">A → Z</option>
          <option value="priceAsc">Precio ↑</option>
          <option value="priceDesc">Precio ↓</option>
        </select>
        <div class="meta" id="meta"></div>
      </div>
    </div>

    <div class="chipbar" id="chips">
      <div class="chip active" data-cat="ALL">Todos</div>
      <div class="chip" data-cat="SPS">SPS</div>
      <div class="chip" data-cat="LPS">LPS</div>
      <div class="chip" data-cat="Blandos">Blandos</div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">No encontré nada con ese filtro. Prueba otra palabra 😄</div>
  </div>
</main>

<!-- Floating cart button -->
<div class="fab" id="fab" title="Abrir carrito">
  <span class="count" id="count">0</span>
  <strong>Carrito</strong>
</div>

<!-- Drawer -->
<div class="drawerOverlay" id="overlay"></div>
<div class="drawer" id="drawer">
  <div class="drawerHeader">
    <h2>Carrito</h2>
    <button class="btn secondary" id="closeDrawer">Cerrar</button>
  </div>
  <div class="drawerBody" id="drawerBody"></div>
  <div class="drawerFooter">
    <div class="tot">
      <div>
        <div class="small">Total</div>
        <div style="font-weight:900;font-size:18px;" id="total">$0</div>
      </div>
      <button class="btn" id="btnWhats">Pedir por WhatsApp</button>
    </div>
    <div class="small">Tip: puedes ajustar cantidades antes de enviar.</div>
  </div>
</div>

<!-- Modal (zoom) -->
<div class="modal" id="modal">
  <div class="modalBox">
    <div class="modalTop">
      <strong id="modalTitle">Vista previa</strong>
      <button class="btn secondary" id="closeModal">Cerrar</button>
    </div>
    <img id="modalImg" class="modalImg" alt="" />
  </div>
</div>

<script>
  const WHATSAPP_PHONE = "525544494171";

  const state = {
    catalog: null,
    cat: 'ALL',
    q: '',
    sort: 'recent',
    cart: new Map() // id -> { item, qty }
  };

  function money(n){
    try { return new Intl.NumberFormat('es-MX').format(n); }
    catch { return String(n); }
  }

  function parseIdDate(id){
    // id: yyyyMMdd_HHmmss__...
    const m = /^([0-9]{4})([0-9]{2})([0-9]{2})_([0-9]{2})([0-9]{2})([0-9]{2})/.exec(id || '');
    if(!m) return 0;
    const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
    const hh = Number(m[4]), mm = Number(m[5]), ss = Number(m[6]);
    return new Date(y, mo, d, hh, mm, ss).getTime();
  }

  function normalize(s){
    return (s || '').toString().toLowerCase();
  }

  function getItems(){
    const items = (state.catalog?.items || []).slice();

    const q = normalize(state.q).trim();
    const cat = state.cat;

    let filtered = items.filter(x => {
      const okCat = (cat === 'ALL') ? true : x.category === cat;
      const okQ = q ? normalize(x.species).includes(q) : true;
      return okCat && okQ;
    });

    switch(state.sort){
      case 'az':
        filtered.sort((a,b) => (a.species || '').localeCompare(b.species || ''));
        break;
      case 'priceAsc':
        filtered.sort((a,b) => (a.price||0) - (b.price||0));
        break;
      case 'priceDesc':
        filtered.sort((a,b) => (b.price||0) - (a.price||0));
        break;
      case 'recent':
      default:
        filtered.sort((a,b) => parseIdDate(b.id) - parseIdDate(a.id));
        break;
    }

    return filtered;
  }

  function setActiveChip(cat){
    document.querySelectorAll('#chips .chip').forEach(ch => {
      ch.classList.toggle('active', ch.dataset.cat === cat);
    });
  }

  function openModal(item){
    const modal = document.getElementById('modal');
    const img = document.getElementById('modalImg');
    document.getElementById('modalTitle').textContent = item.species;
    img.src = item.image;
    img.alt = item.species;
    modal.classList.add('open');
  }

  function closeModal(){
    const modal = document.getElementById('modal');
    const img = document.getElementById('modalImg');
    img.src = '';
    modal.classList.remove('open');
  }

  function addToCart(item){
    const existing = state.cart.get(item.id);
    if(existing){
      existing.qty += 1;
    } else {
      state.cart.set(item.id, { item, qty: 1 });
    }
    renderCart();
  }

  function changeQty(id, delta){
    const entry = state.cart.get(id);
    if(!entry) return;
    entry.qty += delta;
    if(entry.qty <= 0) state.cart.delete(id);
    renderCart();
  }

  function clearCart(){
    state.cart.clear();
    renderCart();
  }

  function cartCount(){
    let c = 0;
    state.cart.forEach(v => c += v.qty);
    return c;
  }

  function cartTotal(){
    let t = 0;
    state.cart.forEach(v => t += (v.item.price || 0) * v.qty);
    return t;
  }

  function buildWhatsText(){
    if(state.cart.size === 0) return '';

    const lines = ['Hola 👋 quiero apartar:'];
    state.cart.forEach(v => {
      lines.push(`- (${v.qty}) ${v.item.species} — $${money(v.item.price)}`);
    });
    lines.push(`Total: $${money(cartTotal())}`);
    return lines.join('\n');
  }

  function openWhatsApp(){
    const text = buildWhatsText();
    if(!text){
      alert('Tu carrito está vacío.');
      return;
    }
    const phone = (WHATSAPP_PHONE || '').replace(/\D/g,'');
    const url = 'https://wa.me/' + phone + '?text=' + encodeURIComponent(text);
    window.open(url, '_blank');
  }

  function render(){
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');

    const items = getItems();
    grid.innerHTML = '';

    empty.style.display = items.length ? 'none' : 'block';

    items.forEach(item => {
      const el = document.createElement('div');
      el.className = 'card';

      el.innerHTML = `
        <div class="thumb" role="button" aria-label="Ver imagen">
          <img src="${item.image}" alt="${item.species}" loading="lazy" />
          <div class="badge">${item.category}</div>
        </div>
        <div class="content">
          <div class="title">${item.species}</div>
          <div class="row">
            <div>
              <div class="muted">Precio</div>
              <div class="price">$${money(item.price)}</div>
            </div>
            <button class="btn" type="button">Agregar</button>
          </div>
        </div>
      `;

      el.querySelector('.thumb').addEventListener('click', () => openModal(item));
      el.querySelector('button').addEventListener('click', () => addToCart(item));

      grid.appendChild(el);
    });

    const meta = document.getElementById('meta');
    const gen = state.catalog?.generatedAt ? `Actualizado: ${state.catalog.generatedAt}` : '';
    meta.textContent = gen;
  }

  function renderCart(){
    document.getElementById('count').textContent = String(cartCount());
    document.getElementById('total').textContent = '$' + money(cartTotal());

    const body = document.getElementById('drawerBody');
    body.innerHTML = '';

    if(state.cart.size === 0){
      body.innerHTML = `
        <div class="empty">
          Tu carrito está vacío 🙃<br/>
          Agrega algunos corales y se arma.
        </div>
      `;
      return;
    }

    state.cart.forEach(v => {
      const line = document.createElement('div');
      line.className = 'line';
      line.innerHTML = `
        <div style="flex:1;">
          <div style="font-weight:850;">${v.item.species}</div>
          <div class="small">${v.item.category} • $${money(v.item.price)}</div>
          <div class="qty">
            <button type="button" aria-label="menos">−</button>
            <div><strong>${v.qty}</strong></div>
            <button type="button" aria-label="más">+</button>
            <button class="btn secondary" type="button" style="margin-left:auto;">Quitar</button>
          </div>
        </div>
        <div style="font-weight:900;">$${money((v.item.price||0)*v.qty)}</div>
      `;

      const buttons = line.querySelectorAll('button');
      buttons[0].addEventListener('click', () => changeQty(v.item.id, -1));
      buttons[1].addEventListener('click', () => changeQty(v.item.id, +1));
      buttons[2].addEventListener('click', () => state.cart.delete(v.item.id) || renderCart());

      body.appendChild(line);
    });

    const clear = document.createElement('div');
    clear.style.marginTop = '12px';
    clear.innerHTML = `<button class="btn secondary" type="button">Vaciar carrito</button>`;
    clear.querySelector('button').addEventListener('click', clearCart);
    body.appendChild(clear);
  }

  function openDrawer(){
    document.getElementById('overlay').classList.add('open');
    document.getElementById('drawer').classList.add('open');
  }

  function closeDrawer(){
    document.getElementById('overlay').classList.remove('open');
    document.getElementById('drawer').classList.remove('open');
  }

  async function init(){
    const res = await fetch('catalog.json', { cache: 'no-store' });
    state.catalog = await res.json();

    // events
    document.querySelectorAll('#chips .chip').forEach(ch => {
      ch.addEventListener('click', () => {
        state.cat = ch.dataset.cat;
        setActiveChip(state.cat);
        render();
      });
    });

    document.getElementById('q').addEventListener('input', (e) => {
      state.q = e.target.value;
      render();
    });

    document.getElementById('sort').addEventListener('change', (e) => {
      state.sort = e.target.value;
      render();
    });

    document.getElementById('fab').addEventListener('click', openDrawer);
    document.getElementById('overlay').addEventListener('click', closeDrawer);
    document.getElementById('closeDrawer').addEventListener('click', closeDrawer);
    document.getElementById('btnWhats').addEventListener('click', openWhatsApp);

    document.getElementById('modal').addEventListener('click', (e) => {
      if(e.target.id === 'modal') closeModal();
    });
    document.getElementById('closeModal').addEventListener('click', closeModal);

    render();
    renderCart();
  }

  init();
</script>
</body>
</html>
